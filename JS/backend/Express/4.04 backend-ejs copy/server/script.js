import express from 'express';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

// 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
//////////////////////////////////////////////////////////////////////////////////////
const app = express();
const __dirname = dirname(fileURLToPath(import.meta.url));
const PORT = 3000; // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙˆØ±Øª Ø¥Ù„Ù‰ 3000 ÙˆÙ‡Ùˆ Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹

// 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ Middleware
//////////////////////////////////////////////////////////////////////////////////////
// Ù„ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ø¹Ø¨Ø± POST (req.body)
app.use(express.urlencoded({ extended: true }));
// Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù…Ø«Ù„ Ù…Ù„ÙØ§Øª CSS Ùˆ JavaScript)
// Ø§Ù„Ù…Ø³Ø§Ø± Ù‡Ù†Ø§: Ø§Ø±Ø¬Ø¹ Ù„Ù„Ø®Ù„Ù (..) Ø«Ù… Ø§Ø¯Ø®Ù„ Ù…Ø¬Ù„Ø¯ 'public'
app.use(express.static(join(__dirname, '..', 'public')));
/* app.use(express.static(join(__dirname, 'public'))); */

// 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ (EJS)
//////////////////////////////////////////////////////////////////////////////////////
app.set('view engine', 'ejs');
// ÙŠØ®Ø¨Ø± Express Ø¨Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª EJS (views)
app.set('views', join(__dirname, '..', 'views'));

// 4. Ù…Ø³Ø§Ø±Ø§Øª GET
//////////////////////////////////////////////////////////////////////////////////////

// Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬)
app.get('/', (req, res) => {
  // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… req.query Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† URL (Ù…Ø«Ù„Ø§Ù‹ /?message=Welcome)
  const welcomeMessage = req.query.message || 'Please submit your name.';
  res.render('home', { message: welcomeMessage });
});

// Ù…Ø³Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø¨Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬)
app.get('/contact', (req, res) => {
  // ØªÙ…Ø±ÙŠØ± Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø§Ø³Ù…
  res.render('contact', { name: 'Visitor', source: 'Direct Link' });
});

// 5. Ù…Ø³Ø§Ø± POST (Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬)
//////////////////////////////////////////////////////////////////////////////////////

// Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† ØµÙØ­Ø© home
app.post('/submit-name', (req, res) => {
  // ðŸ’¡ ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… req.body Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  const submittedName = req.body.name;

  if (submittedName) {
    // ðŸ’¡ ØªØ­Ø³ÙŠÙ†: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Redirect) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Render)
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© contact ÙˆØªÙ…Ø±ÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¹Ø¨Ø± Query String
    // Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ù…Ø´ÙƒÙ„Ø© "Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬" Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
    res.redirect(`/contact-result?name=${encodeURIComponent(submittedName)}`);
  } else {
    res.redirect('/?message=Name_is_required');
  }
});

// 6. Ù…Ø³Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªØ§Ø¦Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
//////////////////////////////////////////////////////////////////////////////////////

// Ù…Ø³Ø§Ø± ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Redirect) Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
app.get('/contact-result', (req, res) => {
  // ðŸ’¡ ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… req.query Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù…Ù† URL Ø¨Ø¹Ø¯ Ø§Ù„Ù€ Redirect
  const userName = req.query.name || 'Anonymous User';

  res.render('contact', { name: userName, source: 'Form Submission' });
});

// 7. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
//////////////////////////////////////////////////////////////////////////////////////
app.listen(PORT, () => {
  console.log(`Server is running at http://localhost:${PORT}`);
});
